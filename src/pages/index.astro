---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

// Get all blog posts and sort by date (most recent first)
const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort((a, b) => {
  const dateA = new Date(a.id.substring(0, 10));
  const dateB = new Date(b.id.substring(0, 10));
  return dateB.getTime() - dateA.getTime();
});

// Function to extract excerpt from content
function extractExcerpt(content: string, limit = 150): string {
  // Remove frontmatter and markdown formatting
  const cleanContent = content
    .replace(/^---[\s\S]*?---/, '') // Remove frontmatter
    .replace(/^#+\s*/gm, '') // Remove headers
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Convert links to text
    .replace(/`([^`]+)`/g, '$1') // Remove code backticks
    .replace(/\*\*([^*]+)\*\*/g, '$1') // Remove bold
    .replace(/\*([^*]+)\*/g, '$1') // Remove italic
    .trim();
  
  // Get first paragraph or sentence
  const sentences = cleanContent.split(/[.!?]\s+/);
  let excerpt = sentences[0];
  
  if (excerpt.length < limit && sentences.length > 1) {
    excerpt = sentences.slice(0, 2).join('. ') + '.';
  }
  
  if (excerpt.length > limit) {
    excerpt = excerpt.substring(0, limit).trim() + '...';
  }
  
  return excerpt;
}
---

<Layout title="Martin Emde">
  <!-- About Section -->
  <section class="bg-white rounded-lg border border-gray-200 p-8 shadow-sm mb-12">
    <div class="prose prose-gray max-w-none prose-a:text-blue-600 prose-a:no-underline hover:prose-a:underline">
      <p class="text-lg text-gray-700 leading-relaxed">
        Software Engineer Consultant at <a href="https://cloudcity.io/" itemprop="affiliation" rel="external" title="Where I work.">Cloud City Development</a>.
        Maintainer of <a href="https://github.com/rubygems/rubygems" rel="external">RubyGems</a>, <a href="https://rubygems.org" rel="external">RubyGems.org</a> &amp; Bundler.
        Learn more about my work on <a href="https://github.com/martinemde" rel="external" title="When I make code, I put it here unless I don't.">GitHub</a>.
      </p>
    </div>
  </section>

  <!-- Blog Posts Section -->
  <section>
    <h2 class="text-2xl font-semibold text-gray-900 mb-8">Latest Updates</h2>
    <div class="space-y-8">
      {sortedPosts.map(async (post) => {
        const date = post.id.substring(0, 10);
        const slug = post.id.substring(11).replace('.md', '');
        const url = `/${date.replace(/-/g, '/')}/${slug}.html`;
        const { body } = await post.render();
        const excerpt = extractExcerpt(post.body);
        
        return (
          <article class="bg-white rounded-lg border border-gray-200 p-8 shadow-sm hover:shadow-md transition-shadow">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">
              <a href={url} class="text-gray-900 hover:text-blue-600 transition-colors">{post.data.title}</a>
            </h3>
            <p class="text-gray-600 leading-relaxed mb-4">{excerpt}</p>
            <a href={url} class="inline-flex items-center text-blue-600 hover:text-blue-700 transition-colors font-medium">
              Continue reading â†’
            </a>
          </article>
        );
      })}
    </div>
  </section>
</Layout>