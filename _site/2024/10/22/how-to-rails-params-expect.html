<!doctype html>
<html lang="en-US">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>How to: Rails `params.expect` - Martin Emde</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Overlock:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/assets/css/tailwind.css" />
    <link rel="stylesheet" href="/assets/css/main.css" />
    <link rel="stylesheet" href="/assets/css/highlight.css" />
  </head>
  <body class="bg-stone-100 text-slate-900 dark:bg-slate-800 dark:text-white">
    <div class="flex min-h-screen flex-col">
      <header class="mx-auto flex w-full max-w-3xl flex-row items-center justify-between px-8 py-8">
        <h1 class="flex text-4xl font-bold">
          <a href="/">Martin Emde</a>
        </h1>
        <nav class="flex text-lg">
          <ul class="flex space-x-4">
            <li><a href="/" class="no-underline">About</a></li>
          </ul>
        </nav>
      </header>
      <main class="mx-auto mb-20 max-w-full md:px-8 lg:max-w-3xl">
        <div class="mb-20 bg-white px-10 pt-14 pb-20 shadow-lg md:rounded-lg dark:bg-slate-950">
          <article class="md:prose-md prose prose-slate dark:prose-invert">
            <h1>How to: Rails `params.expect`</h1>
            <p>
              In this post I will describe
              <a href="https://github.com/rails/rails/pull/51674"
                >the new
                <code class="language-plaintext highlighter-rouge">params.expect</code> feature</a
              >
              that I recently added to Rails 8 and go over how it works and how to use it.
            </p>

            <p>
              Update: For an implementation guide, see
              <a href="/2024/12/21/how-to-convert-to-rails-params-expect.html"
                >my second post on
                <code class="language-plaintext highlighter-rouge">params.expect</code></a
              >.
            </p>

            <h2 id="params-an-attack-vector">params: An Attack Vector</h2>

            <p>All web application programmers learn not to trust user input.</p>

            <p>
              Rails has long provided a simple pattern to prevent param tampering:
              <code class="language-plaintext highlighter-rouge">params.permit</code>. This protects
              our app from users that may alter params in order to insert attributes or alter
              behavior, like assigning admin to yourself.
            </p>

            <figure class="highlight">
              <pre><code class="language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">update</span>
    <span class="n">user_params</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:favorite_pie</span><span class="p">)</span>

    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="ss">:user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">:edit</span>
    <span class="k">end</span>
  <span class="k">end</span></code></pre>
            </figure>

            <p>
              This works great when users submit the form correctly and even when they try to insert
              extra fields, like
              <code class="language-plaintext highlighter-rouge">admin=true</code> into the params.
              These attacks get filtered out.
            </p>

            <p>
              But protecting us from correctly submitted forms and extra attributes is not enough.
              What if, as we regularly see on RubyGems.org, a user is trying to break your
              application by submitting malformed params? Problems start to emerge.
            </p>

            <p>
              The solution in Rails 8 is the new
              <code class="language-plaintext highlighter-rouge">params.expect</code>.
            </p>

            <!--more-->

            <h2 id="how-do-i-use-paramsexpect">
              How do I use <code class="language-plaintext highlighter-rouge">params.expect</code>?
            </h2>

            <p>
              If you don‚Äôt want to dig into Rails parameter filtering right now, you can simply do
              the following in Rails 8:
            </p>

            <figure class="highlight">
              <pre><code class="language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">update</span>
    <span class="c1"># OLD</span>
    <span class="c1"># user_params = params.require(:user).permit(:name, :favorite_pie)</span>

    <span class="c1"># NEW (see how it mirrors the expected params?)</span>
    <span class="n">user_params</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="nf">expect</span><span class="p">(</span><span class="ss">user: </span><span class="p">[</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:favorite_pie</span><span class="p">])</span>

    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="c1"># ...</span>
  <span class="k">end</span></code></pre>
            </figure>

            <p>
              When using <code class="language-plaintext highlighter-rouge">params.expect</code>,
              mirror the structure of the params hash that you expect. In the example above, the key
              <code class="language-plaintext highlighter-rouge">:user</code> will be required and
              the keys
              <code class="language-plaintext highlighter-rouge">:name, :favorite_pie</code> will be
              permitted (as long as they are not arrays or hashes themselves).
            </p>

            <p>
              The <code class="language-plaintext highlighter-rouge">params.expect</code> method
              should, in most cases, fully replace
              <code class="language-plaintext highlighter-rouge">permit</code> and
              <code class="language-plaintext highlighter-rouge">require</code> in almost all
              controller code. Unless a param is optional, you probably want to use
              <code class="language-plaintext highlighter-rouge">expect</code>.
            </p>

            <p>
              The benefit, which I will go into in this post, is that expect will also enforce the
              structure of the params. If
              <code class="language-plaintext highlighter-rouge">params[:user]</code> returns
              something unexpected, like a
              <code class="language-plaintext highlighter-rouge">String</code> or an
              <code class="language-plaintext highlighter-rouge">Array</code>, Rails will now
              correctly tell the client that they have submitted a malformed request, rending a 400
              error.
            </p>

            <p>Additionally, if you expect an array, you need to be explicit about it.</p>

            <figure class="highlight">
              <pre><code class="language-ruby" data-lang="ruby"><span class="c1"># allows an Array of favorite_pies, but not an array of users.</span>
<span class="n">params</span><span class="p">.</span><span class="nf">expect</span><span class="p">(</span><span class="ss">user: </span><span class="p">[</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">favorite_pies: </span><span class="p">[[</span> <span class="ss">:flavor</span> <span class="p">]]</span> <span class="p">])</span>
<span class="c1">#     Note the explicit Array format above: ^^         ^^</span></code></pre>
            </figure>

            <p>
              The rest of this post will dig into why and how the new syntax works, how to use it,
              and some of the gotchas that you might experience with this change.
            </p>

            <h2 id="the-problem-of-params-tampering">The Problem of Params Tampering</h2>

            <p>
              I briefly alluded to the problem with the old params filtering pattern. What if the
              user sends this?
            </p>

            <figure class="highlight">
              <pre><code class="language-ruby" data-lang="ruby"><span class="no">PATCH</span> <span class="sr">/user/</span><span class="mi">1</span><span class="p">?</span><span class="n">user</span><span class="o">=</span><span class="n">hax</span></code></pre>
            </figure>

            <p>The result using our old code above is an error:</p>

            <div class="language-plaintext highlighter-rouge">
              <div class="highlight">
                <pre class="highlight"><code>NoMethodError in UsersController#update
undefined method `permit' for an instance of String
</code></pre>
              </div>
            </div>

            <p>
              It‚Äôs not <em>so</em> bad. The filtering did prevent bad input, but it raised a 500
              error. Not great.
            </p>

            <p>
              It probably also got reported to an exception tracking service. Also not great if
              you‚Äôre getting paged.
            </p>

            <h3 id="nomethoderror-undefined-method-permit-for-instance-of-string">
              NoMethodError: undefined method ‚Äòpermit‚Äô for instance of String
            </h3>

            <p>
              Not only is an unhandled 500 annoying, but the error raised is extremely generic. We
              cannot safely rescue
              <code class="language-plaintext highlighter-rouge">NoMethodError</code> and carry on
              like nothing happened. We will end up suppressing errors we really want to know about.
            </p>

            <p>
              Now, in RubyGems.org‚Äôs case, the hacker sees an unhandled 500, so they try it again.
              And again. And Again. And Again.
            </p>

            <p>Now someone is definitely getting paged for a high 500 error rate. üò≠</p>

            <p>
              You could change all of your params filtering to be really careful, checking each type
              in the params chain before calling the next method, but this is tedious and ugly
              (believe me, I tried. It prompted me to push this fix upstream to Rails.)
            </p>

            <h3 id="digging-into-actioncontrollerparameters-internals">
              Digging into
              <code class="language-plaintext highlighter-rouge">ActionController::Parameters</code>
              internals.
            </h3>

            <p>
              The problem happens because
              <code class="language-plaintext highlighter-rouge">require</code> does not, must not,
              care about what type it is returning. It cannot ensure that an instance of
              <code class="language-plaintext highlighter-rouge">ActionController::Parameters</code>
              is returned whenever one is needed, but return the
              <code class="language-plaintext highlighter-rouge">String</code> or
              <code class="language-plaintext highlighter-rouge">Array</code> when you want it to.
              Unfortunately, the user agent sending the request is in control of what type is
              returned from <code class="language-plaintext highlighter-rouge">require</code>.
            </p>

            <p>
              Params formats are defined by a Rails standardized format compatible with
              <code class="language-plaintext highlighter-rouge">www-form-urlencoded</code>. If you
              want to send a hash, an array or a string, Rails provides the following pattern for
              doing so:
            </p>

            <p><em>Note that I am ignoring URI % encoding for readability.</em></p>

            <figure class="highlight">
              <pre><code class="language-ruby" data-lang="ruby"><span class="c1"># A Hash:</span>
<span class="no">PATCH</span> <span class="sr">/users/</span><span class="mi">1</span><span class="o">/</span><span class="p">?</span><span class="n">user</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span><span class="o">=</span><span class="n">martin</span><span class="o">&amp;</span><span class="n">user</span><span class="p">[</span><span class="n">favorite_pie</span><span class="p">]</span><span class="o">=</span><span class="n">pumpkin</span>
<span class="c1"># params = { "user" =&gt; { "name" =&gt; "martin", "favorit_pie" =&gt; "pumpkin" } }</span>

<span class="c1"># An Array:</span>
<span class="no">POST</span> <span class="sr">/pies?pies[][flavor]=pumpkin&amp;pies[][flavor]=pecan
# params = { "pies" =&gt; [
#            { "flavor" =&gt; "pumpkin" },
#            { "flavor" =&gt; "pecan" }
#          ] }

# A String:
POST /se</span><span class="n">arch?q</span><span class="o">=</span><span class="n">hello</span><span class="o">+</span><span class="n">world</span>
<span class="c1"># params = { "q" =&gt; "hello world" }</span></code></pre>
            </figure>

            <h2 id="whats-going-on-exactly">What‚Äôs going on exactly?</h2>

            <p>Let‚Äôs try our problem query in the rails console:</p>

            <figure class="highlight">
              <pre><code class="language-ruby" data-lang="ruby"><span class="n">irb</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Parameters</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">user: </span><span class="s2">"hax"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;ActionController::Parameters {"user"=&gt;"hax"} permitted: false&gt;</span>
<span class="n">irb</span><span class="o">&gt;</span> <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"hax"</span>
<span class="n">irb</span><span class="o">&gt;</span> <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">)</span>
<span class="n">undefined</span> <span class="nb">method</span> <span class="sb">`permit' for an instance of String (NoMethodError)

params.require(:user).permit(:name, :email)
                     ^^^^^^^</span></code></pre>
            </figure>

            <p>
              As you can see, the return value of
              <code class="language-plaintext highlighter-rouge">require(:user)</code> is
              <code class="language-plaintext highlighter-rouge">"hax"</code> and
              <code class="language-plaintext highlighter-rouge">"hax"</code> does not have a method
              named <code class="language-plaintext highlighter-rouge">permit</code>.
            </p>

            <p>
              Despite us asking nicely for users to submit a hash for the
              <code class="language-plaintext highlighter-rouge">:user</code> key, they sent a
              String. Hrmph!
            </p>

            <h3 id="and-what-are-you-going-to-do-about-it">
              And what are you going to do about it?
            </h3>

            <p>
              Since these URI query string formats are controlled by the client, we need a way to
              filter out unexpected formats.
            </p>

            <p>
              Our goal is the tell the user that their request is malformed by sending a 400 Bad
              Request error back to the client. Rails will do this automatically when
              <code class="language-plaintext highlighter-rouge">ParameterMissing</code> is raised,
              so we can do that ourselves for the wrong type.
            </p>

            <figure class="highlight">
              <pre><code class="language-ruby" data-lang="ruby"><span class="c1"># ugly</span>
<span class="n">user_params</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
<span class="k">raise</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">ParameterMissing</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="p">{})</span> <span class="k">unless</span> <span class="n">user_params</span><span class="p">.</span><span class="nf">respond_to?</span><span class="p">(</span><span class="ss">:permit</span><span class="p">)</span>
<span class="n">user_params</span> <span class="o">=</span> <span class="n">user_params</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:favorite_pie</span><span class="p">)</span></code></pre>
            </figure>

            <p>
              I discovered a better version when I was trying to solve this problem for
              RubyGems.org. It has a few flaws, but it works well enough.
            </p>

            <figure class="highlight">
              <pre><code class="language-ruby" data-lang="ruby"><span class="c1"># a little better</span>
<span class="n">user_params</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">user: </span><span class="p">[</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:favorite_pie</span><span class="p">]).</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span></code></pre>
            </figure>

            <p>
              The above, or something like it, is what you‚Äôll need to do on versions of Rails before
              Rails 8.
            </p>

            <h2 id="the-array-problem">The Array problem</h2>

            <p>
              Using <code class="language-plaintext highlighter-rouge">permit</code> in this less
              common way shown above is better, but there is a problem with Arrays that is almost as
              bad as the problem we were trying to solve in the first place.
            </p>

            <p>
              The <code class="language-plaintext highlighter-rouge">permit</code> method is more
              permissive than we would really like. The format
              <code class="language-plaintext highlighter-rouge"
                >permit(user: [:name, :favorite_pie])</code
              >
              will allow either of the following params:
            </p>

            <figure class="highlight">
              <pre><code class="language-ruby" data-lang="ruby"><span class="c1"># allowed params</span>
<span class="no">ActionController</span><span class="o">::</span><span class="no">Parameters</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">user: </span><span class="p">{</span> <span class="ss">name: </span><span class="s2">"Martin"</span> <span class="p">})</span>
<span class="c1"># also allowed, maybe not what you expected</span>
<span class="no">ActionController</span><span class="o">::</span><span class="no">Parameters</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">user: </span><span class="p">[</span> <span class="p">{</span> <span class="ss">name: </span><span class="s2">"Martin"</span> <span class="p">}</span> <span class="p">])</span></code></pre>
            </figure>

            <p>
              When <code class="language-plaintext highlighter-rouge">permit</code> is given an
              array as the value, e.g.
              <code class="language-plaintext highlighter-rouge">[:name]</code>, it allows either a
              hash with those keys, or an array of hashes with those keys. This can be inconvenient
              at best and may pose a security problem if use the params in a particular way.
            </p>

            <p>You can solve this problem, but again this is getting ugly.</p>

            <figure class="highlight">
              <pre><code class="language-ruby" data-lang="ruby"><span class="n">user_params</span> <span class="o">=</span> <span class="n">user_params</span><span class="p">.</span><span class="nf">first</span> <span class="k">if</span> <span class="n">user_params</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span></code></pre>
            </figure>

            <h3 id="a-new-syntax-for-arrays-in-params">
              A New Syntax for Arrays in
              <code class="language-plaintext highlighter-rouge">params</code>
            </h3>

            <p>
              In order to avoid the Array problem,
              <code class="language-plaintext highlighter-rouge">expect</code> now
              <em>only</em> accepts hashes when given the format
              <code class="language-plaintext highlighter-rouge">[:name]</code>. If you actually
              want an Array, specify it explicitly with the new (and hopefully not confusing)
              format:
            </p>

            <figure class="highlight">
              <pre><code class="language-ruby" data-lang="ruby"><span class="c1"># explicit array syntax: a double array</span>
<span class="n">comments</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="nf">expect</span><span class="p">(</span><span class="ss">comments: </span><span class="p">[[</span><span class="ss">:text</span><span class="p">]])</span></code></pre>
            </figure>

            <p>
              This syntax will only permit an Array and reject, with a 400 error, any other params
              structure (like a Hash or String).
            </p>

            <figure class="highlight">
              <pre><code class="language-ruby" data-lang="ruby"><span class="n">params</span> <span class="o">=</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Parameters</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
    <span class="ss">comments: </span><span class="p">[</span>
        <span class="p">{</span><span class="ss">text: </span><span class="s2">"hello"</span><span class="p">},</span>
        <span class="p">{</span><span class="ss">text: </span><span class="s2">"world"</span><span class="p">}</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">comments</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="nf">expect</span><span class="p">(</span><span class="ss">comments: </span><span class="p">[[</span><span class="ss">:text</span><span class="p">]])</span>
<span class="c1"># =&gt; { "comments" =&gt; [ {"text" =&gt; "hello"}, {"text" =&gt; "world"} ] }</span>
<span class="n">comments</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="nf">expect</span><span class="p">(</span><span class="ss">comments: </span><span class="p">[</span><span class="ss">:text</span><span class="p">])</span>
<span class="c1"># =&gt; ActionController::ParameterMissing</span></code></pre>
            </figure>

            <p>
              By resolving this ambiguity in params parsing and improving the syntax and security of
              features used by every Rails engineer, we are able to reduce false alarms, better
              protect application data, and maybe reduce the number of engineers getting paged in
              the middle of the night.
            </p>

            <h2 id="lets-keep-making-this-better">Let‚Äôs keep making this better</h2>

            <p>
              Right now I‚Äôm committed to improving the Ruby, RubyGems, and Ruby on Rails ecosystems
              for everyone. The RubyGems.org team, and I ‚Äúupstream‚Äù improvements to the gems we use
              as a matter of principle. We want Ruby to be the best choice for building
              applications. We also work closely with other ecosystems like Python and Rust, to
              ensure best practices across languages.
            </p>

            <p>
              Are you and your company comfortable with your reliance on open source? To avoid worst
              case scenarios, your company needs at least one engineer on your team dedicating their
              time to open source maintenance. If you use Ruby, then you rely on the work of the
              RubyGems team. I‚Äôd love to work with you to help your team succeed in the Ruby
              ecosystem.
            </p>

            <p>
              If you would like to work with me and my colleagues to improve or maintain the code
              you rely on, connect with me at
              <a href="https://cloudcity.io">Cloud City Development</a> where you can hire our world
              class team.
            </p>
          </article>
        </div>
      </main>
    </div>
    <script type="text/javascript">
      //<![CDATA[
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-19274402-1']);
      _gaq.push(['_setDomainName', '.martinemde.com']);
      _gaq.push(['_trackPageview']);
      (function () {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src =
          ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') +
          '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
      })();
      //]]>
    </script>
  </body>
</html>
